<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/customPrism.css">
    <link rel="stylesheet" href="../css/prism.css">
    <script src="../js/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  </head>
  <body id="program">
    <h2>file_download</h2>
    <h3>html</h3>
    <pre class="prettyprint">
      <xmp>
        <input type="file" name="file[]" data-target="file">
        <form action="{{route('image')}}" method="post" enctype="multipart/form-data">
          @csrf
        @if ($errors->any())
          <div class="alert alert-danger">
            <ul>
              @foreach ($errors->all() as $error)
              <li>{{ $error }}</li>
              @endforeach
            </ul>
          </div>
          @endif
          <input
            name="file"
            type="file"
            accept="image/*"
            value=""
          >
          <input name="" type="submit" value="上傳">
        </form>
      </xmp>
    </pre>
    <h3>js</h3>
    <pre class="prettyprint">
      <xmp>
        <script>
        function fileFn(e) {
          const file = e.target.files[0];
          //驗證
          const validFileTypes = ["jpeg", "jpg", "png", "pdf", "doc", "docx", "xls", "xlsx"];
          const isValidFileType = validFileTypes.includes(file.name.split('.').pop());
          if (!isValidFileType) {
            alert("格式只能是jpg,png,pdf,doc,xls");
            e.target.value = '';
            return;
          }
          const isValidFileSize = file.size / 1024 / 1024 < 5;
          if (!isValidFileSize) {
            alert("檔案需小於 5MB!");
            e.target.value = '';
            return;
          }
        }
        document.querySelector('[data-target="file"]').addEventListener('change', fileFn)
        </script>
      </xmp>
    </pre>
    <h3>php 檔案存檔</h3>
    <pre class="prettyprint">
      <xmp>
        if(isset($input['file'])){
        $files = $input['file'];
        foreach($files as $key => $value){
          $uploadedFile = $files[$key];
          $path = $uploadedFile->store('public');//存的位置 storage/app/public/自訂亂碼名稱
          $filename = $uploadedFile->getClientOriginalName(); //檔名
          $data = new data_appendix;
          $data->src = $path;
          $data->name = $filename;
          $data->save();
        }
      }
      </xmp>
    </pre>
    <h3>php 檔案刪除</h3>
    <pre class="prettyprint">
      <xmp>
        $appendix = data_appendix::where('id', $id)->first();
      unlink(storage_path('app/'.$appendix['src'])); //delet store/app/fileName
      data_appendix::find($id)->delete(); //delet data
      </xmp>
    </pre>
    <h3>blade 下載檔案</h3>
    <p>Storage::url('檔案名稱') 取得Storage URL</p>
    <pre class="prettyprint">
      <xmp>
        @if(isset($appendixs))
        @foreach ($appendixs as $appendix)
        <a href="{{ Storage::url(str_replace('public/','',$appendix->src)) }}" download="{{$appendix->name}}">{{$appendix->name}}</a>
        @endforeach
      @endif
      </xmp>
    </pre>
    <h3>另開檔案,須裝google表單不然會變下載</h3>
    <pre class="prettyprint">
      <xmp>
        <a href="javascript:;" onclick="window.open('{{ Storage::url(fileSrc) }}','_blank')">
          {{fileName}}
        </a>
      </xmp>
    </pre>
    <h4>參考</h4>
    <ul>
      <li>
        <a href="https://stackoverflow.com/questions/55028870/how-to-download-file-from-storage-folder-in-blade-page-in-laravel">
          how
        to download file from storage folder in blade page in laravel?
        </a>
      </li>
      <li>
        <a href="https://ithelp.ithome.com.tw/articles/10228413">上傳檔案</a>
      </li>
    </ul>
  </body>
</html>
