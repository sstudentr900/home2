<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>

<body>
    <script>
        //Promise------------------------------------------------------------------------------------------------
        //https://ithelp.ithome.com.tw/articles/10221800
        //then接收成功,catch接收失敗,finally不管成功失敗都會讀取
        let wait = new Promise((resolve, reject) => {
            console.log('promise stare')
            let ran = parseInt(Math.random() * 2)
            console.log('ran(0~1)', ran)
            if (ran) {
                resolve('then:' + ran)
            } else {
                reject('catch:' + ran)
            }
        })
        wait.then((data) => {
            console.log(data)
        }).catch((data) => {
            console.log(data)
        }).finally(() => {
            console.log('finally')
        })


        //Chain 鏈接方法
        //https://www.casper.tw/development/2020/02/16/all-new-promise/
        function wait2(ran = 0) {
            return new Promise((resolve, reject) => {
                console.log('promise stare')
                console.log('ran', ran)
                if (ran) {
                    resolve('then:' + ran)
                } else [
                    reject('catch:' + ran)
                ]
            })
        }
        wait2(1).then(data => {
            console.log('1', data)
            return wait2(1)
        }).then(data => {
            console.log('2', data)
            return wait2(1)
        }).then(data => {
            console.log('3', data)
        }).catch(data => {
            console.log(data)
        }).finally(() => {
            console.log('finally')
        })


        //Chain 鏈接方法
        let newPromise1 = new Promise((resolve, reject) => {
            let ran = parseInt(Math.random() * 5000); // 隨機成功或失敗
            setTimeout(function() {
                resolve('隨機時間完成');
            }, ran);
        });

        let newPromise2 = new Promise((resolve, reject) => {
            setTimeout(function() {
                resolve('2 秒完成');
            }, 2000);
        });

        let newPromise3 = new Promise((resolve, reject) => {
            setTimeout(function() {
                resolve('3 秒完成');
            }, 3000);
        });
        newPromise1.then((data1) => {
            console.log('data1', data1);
            return newPromise2.then((data2) => {
                return `${data2} + ${data1}` // 回傳 Promise 內的值，讓下一個 then 可以接收
            });
        }).then((data3) => {
            console.log('data3', data3);
            return newPromise3.then((data4) => {
                return `${data4} + ${data3}` // 回傳 Promise 內的值，讓下一個 then 可以接收
            });
        }).then((data5) => {
            console.log(`最後的 + ${data5}`)
        });


        //ajax promise
        // link:http://huli.logdown.com/posts/292655-javascript-promise-generator-async-es6
        // function a() {
        //     return new Promise(function(resolve) {
        //         $.ajax('http://api')
        //             .done(function(reslt) {
        //                 resolve(reslt);
        //             })
        //     })
        // }

        // function b(id) {
        //     return new Promise(function(resolve) {
        //         $.ajax('http://api', {
        //                 id: id
        //             })
        //             .done(function(reslt) {
        //                 resolve(reslt);
        //             })
        //     })
        // }

        // function c(id) {
        //     return new Promise(function(resolve) {
        //         $.ajax('http://api', {
        //                 id: id
        //             })
        //             .done(function(reslt) {
        //                 resolve(reslt);
        //             })
        //     })
        // }

        // a().then(function(a) {
        //     return b(a[0].id);
        // }).then(function(b) {
        //     return c(b.id);
        // }).then(function(c) {
        //     console.log(c.name);
        // })


        //Promise 的寫法
        //https://pjchender.dev/javascript/js-async-await
        main();

        function main() {
            console.log('start fn'); // STEP 1-1
            get() // STEP 1-2
                .then(process) // STEP 2-1
                .then((result) => console.log('result', result)); // STEP 3-1
        }

        function get() {
            console.log('I am in get out of Promise'); //  STEP 1-3
            return new Promise((resolve, reject) => {
                //  STEP 1-4
                setTimeout(() => resolve('secret'), 1000); //  STEP 1-5 To Step 2 after 1 sec
            });
        }

        function process(value) {
            console.log("I'm in process,", value); //  STEP 2-2
            return new Promise((resolve, reject) => {
                //  STEP 2-3
                setTimeout(() => resolve(`${value}-secret`), 1000); // STEP 2-4 To STEP 3 after 1 sec
            });
        }


        // Promise.all--------------------------------------------------------------------------
        //https://www.casper.tw/development/2020/02/16/all-new-promise/
        let wait3 = function(num) {
            return new Promise((resolve, reject) => {
                resolve(num);
                reject();
            })
        }
        Promise.all([wait3(1), wait3(2), wait3(3)]).then(res => console.log(res)) //[1,2,3]


        //https://wcc723.github.io/javascript/2017/12/30/javascript-async-await/
        var arrays = [1, 5, 6, 8, 2, 3, 4]
        var Fn = (timer) => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    var result = timer > 3 ? true : false
                    console.log(`${timer} : ${result} : ${timer * 500}`);
                    resolve(result);
                }, timer * 500)
            })
        }
        Promise.all(
            arrays.map(async(data) => {
                return await Fn(data)
            })
        ).then((value) => {
            console.log(value)
        })


        //map
        //https://www.techiediaries.com/promise-all-map-async-await-example/
        const capitalizeProductsIds2 = async() => {
            const products = await getProducts()
            return Promise.all(
                products.map(async(product) => {
                    const productId = await getProductId(product);
                    console.log('map', productId);

                    const capitalizedId = await capitalizeId(productId)
                    console.log('map', capitalizedId);
                    return 12
                })
            )
        }
        capitalizeProductsIds2().then((ms) => {
            console.log(ms)
        });


        //Promise.reject、Promise.resolve
        //https://ithelp.ithome.com.tw/articles/10251786
        const p1 = Promise.resolve('Hello World');
        const p2 = Promise.reject('Error!');
        Promise.all([p1, p2])
            .then(success => {
                console.log(success);
            })
            .catch(error => {
                console.log(error); //Error! 
            });

        // Promise.all 使用
        //https://pjchender.dev/javascript/js-async-await
        doubleAndAdd(1, 2).then((value) => {
            console.log(`doubleAndAdd(a, b)is ${value}`);
        });

        async function doubleAndAdd(a, b) {
            const [aAfterDouble, bAfterDouble] = await Promise.all([
                doubleAfterOneSecond(a),
                doubleAfterOneSecond(b),
            ]);
            console.log(
                `a after double is ${aAfterDouble}. b after double is ${bAfterDouble}`
            );
            return aAfterDouble + bAfterDouble;
        }

        function doubleAfterOneSecond(params) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    resolve(params * 2);
                }, 1000);
            });
        }


        // Promise.race--------------------------------------------------------------------------
        //回傳第一個
        // let wait4 = function(num) {
        //     return new Promise((resolve, reject) => {
        //         resolve(num);
        //         reject(num);
        //     })
        // }
        // Promise.race([wait4(1), wait4(2), wait4(3)]).then(res => console.log(res))



        //async函式一定會回傳一個Promise物件--------------------------------------------------------------------------
        //https://ithelp.ithome.com.tw/articles/10252140
        async function func() {
            return 10;
        }
        func() //Promise {<fulfilled>: 10}




        //錯誤處理 async本身會回傳Promise物件用then和catch方法來抽取Promise物件裏的失敗/成功值
        function add(num1, num2) {
            return new Promise((resolve, reject) => {
                window.setTimeout(() => {
                    reject(num1 + num2); //在這裏改成reject，模擬出錯
                }, 1000)
            })
        }

        async function func() {
            const p1 = await add(10, 20);
            const p2 = await add(30, 40);
            return `第一次相加結果：${p1}，第二次相加結果：${p2}`
        }

        func()
            .then(success => {
                console.log(`成功！`, success)
            })
            .catch(error => {
                console.log(`錯誤！`, `最後相加結果：${error}`) //錯誤！ 最後相加結果：30
            });


        //錯誤處理用try...catch處理錯誤情況
        function add(num1, num2) {
            return new Promise((resolve, reject) => {
                window.setTimeout(() => {
                    reject(num1 + num2); //在這裏改成reject，模擬出錯
                }, 1000)
            })
        }

        async function func() {
            try {
                const p1 = await add(10, 20);
                const p2 = await add(30, 40);
                console.log(`第一次相加結果：${p1}，第二次相加結果：${p2}`)

            } catch (error) {
                console.log(`錯誤！`, `最後相加結果：${error}`) //錯誤！ 最後相加結果：30
            }
        }

        func()


        //async,awite 單線往下--------------------------------------------------------------------------
        //https://wcc723.github.io/javascript/2017/12/30/javascript-async-await/
        let runPromise = (someone, timer, success = true) => {
            console.log(`${someone} 開始跑開始`);
            return new Promise((resolve, reject) => {
                // 傳入 resolve 與 reject，表示資料成功與失敗
                if (success) {
                    setTimeout(function() {
                        // 3 秒時間後，透過 resolve 來表示完成
                        resolve(`${someone} 跑 ${timer / 1000} 秒時間(fulfilled)`);
                    }, timer);
                } else {
                    // 回傳失敗
                    reject(`${someone} 跌倒失敗(rejected)`)
                }
            });
        }

        // 此段函式並不會影響其它函示的執行
        runPromise('小明', 3000).then(someone => {
            console.log('小明', someone)
        });
        // 以下這段 console 會在 promise 結束前就執行
        console.log('這裡執行了一段 console');


        //async 將 await 包在裡面
        //Await 顧名思義就是等待，在這個 Promise 結束前後面的程式碼都無法被執行。 單線往下
        const asyncRun = async() => {
            let mingRun = await runPromise('小明', 2000);
            let auntieRun = await runPromise('漂亮阿姨', 1500);
            return `${mingRun}, ${auntieRun}`
        }
        asyncRun().then(string => {
            console.log(string)
        }).catch(response => {
            console.log(string)
        })

        //沒有await 先到先執行
        const asyncRun = async() => {
            runPromise('小明', 2000).then(string => {
                console.log(string)
            });
            runPromise('漂亮阿姨', 500).then(string => {
                console.log(string)
            });
        }
        asyncRun()


        //for loop--------------------------------------------------------------------------
        //https://pjchender.dev/javascript/js-async-await
        //若想要在迴圈中使用 async / await 的寫法需要特別留意， 一般來說在 for, while 或 for...of 這種迴圈中都可以正常使用；但若是在帶有 callback 的迴圈中，例如 forEach, map, filter, reduce 等等，就需要特別留意：
        //1.如果想要在迴圈中使用 await，則可以使用一般的 for 迴圈、for await...of，或 map 搭配 Promise 的寫法，千萬不要使用 forEach。
        //2.若有需要使用 filter 或 reduce 等其他處理陣列的方式，先等陣列的資料完整取得後再來呼叫這些方法。
        const sleep = (ms) => {
            return new Promise((resolve, reject) => {
                console.log(`[sleep-${ms}] invoke`);
                setTimeout(() => {
                    console.log(`[sleep-${ms}] resolve`);
                    // if (ms === 2000) {
                    //   reject(ms)
                    // return
                    // }

                    resolve(ms);
                }, ms);
            });
        };

        // 所有的 Promise 會在此時就發動
        const promises = [sleep(1000), sleep(3000), sleep(2000)];

        // 方法一：使用 for await...of，每個 Promise 結束後可以馬上取得結果
        (async function() {
            for await (const item of promises) {
                console.log('[for await...of] result', item);
            }
        })();

        // 方法二：使用 for...of，每個 Promise 結束後可以馬上取得結果
        (async function() {
            for (const item of promises) {
                const result = await item;
                console.log('[for...of] result', result);
            }
        })();

        // 方法三：使用 for 迴圈，每個 Promise 結束後可以馬上取得結果
        (async function() {
            for (let i = 0; i < promises.length; i++) {
                const result = await promises[i];
                console.log('[for] result', result);
            }
        })();

        // 方法四，使用 Promise.all，一次取得所有結果，需等待所有 Promise resolve 或其中一個被 reject 時終止
        (async function() {
            const results = await Promise.all(promises);
            console.log('[Promise.all] results', results);
        })();

        // 方法五，使用 Promise.allSettled，一次取得所有結果，需等待所有 Pormise 都 resolve(fulfilled) / reject(rejected) 後終止
        (async function() {
            const results = await Promise.allSettled(promises);
            console.log('[Promise.allSettled] results', results);
        })();

        // 方法六：使用 for...of await，一次取得所有結果，需等待所有 Promise resolve 或其中一個被 reject 時終止（不如就用 Promise.all 吧）
        (async function() {
            for (const result of await Promise.all(promises)) {
                console.log('[for...of await] result', result);
            }
        })();



        //https://www.techiediaries.com/promise-all-map-async-await-example/
        const getProducts = () => {
            return new Promise((resolve, reject) => {
                return setTimeout(() => resolve([{
                    id: 'product1'
                }, {
                    id: 'product2'
                }, {
                    id: 'product3'
                }, {
                    id: 'product4'
                }]), 1000)
            })
        }
        const getProductId = (category) => {
            return new Promise((resolve, reject) => {
                return setTimeout(() => resolve(category.id), 1000)
            })
        }
        const capitalizeId = (id) => {
            return new Promise((resolve, reject) => {
                return setTimeout(() => resolve(id.toUpperCase()), 700)
            })
        }

        const capitalizeProductsIds = async() => {
            const products = await getProducts()
            for (let product of products) {
                const productId = await getProductId(product);
                console.log('for', productId);

                const capitalizedId = await capitalizeId(productId);
                console.log('for', capitalizedId);
            }

            console.log('for', products);
        }
        capitalizeProductsIds()


        //callback function--------------------------------------------------------------------------
        //https://pjchender.dev/javascript/js-async-await
        main(); // STEP 1-1

        function main() {
            console.log('start run'); // STEP 1-2
            get((value) => {
                // STEP 1-3
                console.log('value in get', value); // STEP 2-1
                process(value, function(result) {
                    // STEP 2-2
                    console.log(result); // STEP 3-2
                });
            });
        }

        function get(callback) {
            console.log('run fn get'); // STEP 1-4

            return setTimeout(function() {
                // STEP 1-5 into STEP 2
                callback('get data'); // STEP 2 會在兩秒後執行
            }, 2000);
        }

        function process(value, callback) {
            console.log('value in process', value); // STEP 2-3
            return setTimeout(function() {
                // STEP 2-4 in to STEP 3
                callback(`${value}-secrete`); // STEP 3-1 會在等 1 秒（共 3 秒）後執行
            }, 1000);
        }

        /**
         *  main 執行 ->                               // start run(0sec)
         *  get(callback) ->
         *  兩秒後執行 get 裡的 callback
         *  - 1. console.log(value in get get data)   // value in get get data (2sec)
         *  - 2. process(value, callback)             // value in process get data (2sec)
         *  一秒後執行 process 裡的 callback
         *  - 1. console.log(`${value}-secrete`)      // get data-secrete (3sec)
         **/


        //從 Promise 到 async/await--------------------------------------------------------------------------
        //https://pjchender.dev/javascript/js-async-await
        const delay = (ms) => new Promise((resolve) => {
            setTimeout(() => resolve(ms), ms)
        })

        /* case 1 */
        delay(1000).then(data => {
            console.log('case 1: step 1', data)
            return delay(2000).then(data => {
                console.log('case 1: step 2', data)
            })
        });

        /* case 2 */
        delay(1000).then(data => {
            console.log('case 2: step 1', data);
            return delay(2000);
        }).then(data => {
            console.log('case 2: step 2', data)
        })

        // Promise.all
        // const promises = [delay(1000), delay(2000)];
        // Promise.all(promises).then(data => console.log('promise.all', data))

        /* case 3: async / await */
        main();
        async function main() {
            const data1 = await delay(1000);
            console.log('case 3: step 1', data1);
            const data2 = await delay(2000);
            console.log('case 3: step 2', data2)
        }
    </script>
</body>

</html>