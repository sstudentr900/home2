<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/customPrism.css">
    <link rel="stylesheet" href="../css/prism.css">
    <script src="../js/prism.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  </head>
  <body id="program">
    <style>
      /**/
      #program{
        user-select: none;
      }
      #program .title{
        text-align: center;
        justify-content: center;
        font-size: 4rem;
        color: #333844;
        font-weight: bold;
        margin-bottom: 60px;
        margin-top: 0;
      }
      /*select*/
      #program .selectOutLine{
        margin-bottom: 2rem;
        padding: 3rem 2rem;
        background: rgba(255, 255, 255, 0.54);
        border: 1px solid rgba(41, 44, 55, 0.27);
        border-radius: 0.5rem;
        font-size: 2rem;
        text-align: center;
        color: #333844;
      }
      #program .select{
        overflow: hidden;
        height: 70px;
        /* border: 1px solid rgba(41, 44, 55, 0.27); */
      }
      #program .select ul{
        margin: 0;
        position: relative;
        animation-iteration-count: infinite;
        animation-timing-function: linear;
      }
      #program .select ul.active{
        animation-duration: 2s;/* 1*0.03s */
        animation-name: spin;
      }
      #program .select li{
        font-weight: bold;
        height: 70px;
        line-height: 70px;
      }
      @keyframes spin{
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(calc(-100% + 77px));
        }
      }

      /*button*/
      #program .button{
        width: 100%;
        padding: .8rem;
        font-size: 1rem;
        margin-bottom: 2rem;
        font-weight: bold;
        cursor: pointer;
      }
      #program .button.not-allow{
        pointer-events: none;
      }

      /*map*/
      #program .map{
        width: 100%;
      }
      #program .map iframe{
        width: 100%;
        transition: all 0.5s ease;
      }
      #program .map .hidden {
        visibility: hidden;
        opacity: 0;
      }
    </style>

    <h2 class="title">現在要吃什麼</h2>
    <!--  select  -->
    <div class="selectOutLine">
      <div class="select">
        <ul></ul>
      </div>
    </div>

    <!--  按鈕  -->
    <button class="button">轉動輪盤</button>

    <!--  地圖  -->
    <section class="map">
      <iframe
        width="600"
        height="450"
        style="border:0"
        loading="lazy"
        allowfullscreen
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
    </section>
    
    <script>
      //https://sheets.googleapis.com/v4/spreadsheets/{表單id}/values/{表單名稱}?alt=json&key={API金鑰}
      const uri = 'https://sheets.googleapis.com/v4/spreadsheets/13fLPsJrjKANkrStkhh1NKOwrdQ61SEafX1OTUFyBuTs/values/Sheet1?alt=json&key=AIzaSyBjQzpKIdXs5vEoOCh2vLj-8sF4XdXjnfI';
      fetch(uri)
      .then(res=>res.json())
      .then(data=>{
        const select = document.querySelector('.select>ul');
        const items = getData(data.values);
        //map
        function mapFn(button,txt){
          const map = document.querySelector('.map iframe');
          map.src = 'https://www.google.com/maps/embed/v1/place?key=AIzaSyDtu-vNL3cTLQF_Tongrtckzfs8LS4ClkM&q=' + txt;
          map.classList.add('hidden'); // 地圖先消失
          map.addEventListener('load', () => {
            map.classList.remove('hidden');
            button.target.classList.remove('not-allow');
            //select stop animation
            select.classList.remove('active');
            //select result
            select.querySelector('li').innerHTML = txt;
            // console.log('txt:'+txt);
          }, false);
        }
        //清空創建列表亂數
        function creatDate(){
          select.innerHTML='';
          items.forEach(item=>{
            select.insertAdjacentHTML('beforeend','<li>'+item['shops']+'</li>');
          })
          //亂數
          const random = function(array){
            const max = array.length - 1;
            const min = 0;
            return Math.floor(Math.random() * (max - min + 1)) + min;
          };
          const shops = items[random(items)]['shops'];
          //亂數決定中選店家
          // console.log('亂數:');
          // console.log(txt);
          return shops;
        }
        //get data try obj 轉動速度
        function getData(datas){
          const array = [];
          for(var i in datas) {
            if(i>0){
              let item = {};
              item[datas[0][0]] = datas[i][0];
              item[datas[0][1]] = datas[i][1];
              array.push(item);
            }
          }
          const max = array.length - 1;
          const second = (0.04*max).toFixed(1);
          select.style.animationDuration = second+"s";
          select.insertAdjacentHTML('beforeend','<li>'+array[0]['shops']+'</li>');
          // console.log('get json:');
          // console.log(datas);
          // console.log('try object:');
          // console.log(items);
          // console.table(items);
          return array;
        }
        //buttonFn
        function buttonFn(e){
          e.preventDefault();

          //禁止按鈕再被點擊
          e.target.classList.add('not-allow');

          //清空創建列表亂數
          const txt = creatDate();

          //select stare animation
          select.classList.add('active');

          //1.5s移除動畫 
          setTimeout(() => {
            // 改變地圖位置
            mapFn(e,txt);
          }, 1500);
        }
        //按鈕
        document.querySelector('.button').addEventListener('click',buttonFn)
      })
    </script>

    <!-- <h2>心得筆記</h2> -->
    <!-- <h2>1.GCP新增新專案</h2>
    <p>
      進到
      <a href="https://console.cloud.google.com/welcome?project=constant-disk-141915&hl=zh-TW">Google Cloud Platform</a>
      的頁面按下新增專案，取好專案名稱後即可新增。
    </p>
    <h2>2.開通 Google Sheets API 功能</h2>
    <p>
      有了 GCP 的專案後，進到 API 程式庫：
      <a href="https://console.cloud.google.com/apis/library?hl=zh-TW">Google Cloud Platform</a>
      搜尋欄中搜尋「sheet」，會看到一項「Google Sheets API」：
    </p>
    <img src="https://i0.wp.com/i.imgur.com/MKOgxE2.png?w=840&ssl=1" alt="">
    <p>點擊後按下「啟用」，專案就會開通 Google Sheets API 的功能：</p>
    <img src="https://i0.wp.com/i.imgur.com/MbCk5V7.png?w=840&ssl=1" alt="">
    <h2>3.建立憑證</h2>
    <a href="https://console.cloud.google.com/apis/credentials/wizard?hl=zh-TW">網址</a>
    <img src="https://i0.wp.com/i.imgur.com/f9BITJH.png?w=840&ssl=1" alt="">
    <h2>4.建立 API 金鑰</h2>
    <img src="https://i0.wp.com/i.imgur.com/1Oey3Ae.png?w=840&ssl=1" alt="">
    <p>取得API 金鑰</p>
    <img src="https://i0.wp.com/i.imgur.com/oiTe1eb.png?w=840&ssl=1" alt="">
    <h2>Google Sheets URL</h2>
    <ul>
      <li>{表單id} 表單網址(../d/{表單id}/..)</li>
      <li>{表單名稱} 試算表的名稱</li>
    </ul>
    <pre class="prettyprint">
      <xmp>
        https://sheets.googleapis.com/v4/spreadsheets/{表單id}/values/{表單名稱}?alt=json&key={API金鑰}
      </xmp>
    </pre>
    <h2>範例:</h2>
    <pre class="prettyprint">
      <xmp>
        https://sheets.googleapis.com/v4/spreadsheets/{表單id}/values/{表單名稱}?alt=json&key={API金鑰}
      </xmp>
    </pre> -->
    <!-- <hr>
    <h4>參考</h4>
    <ul>
      <li>
        <a href="https://www.letswrite.tw/gas-google-sheet/" target="_blank">取得 Google Sheets / Excel 資料</a>
      </li>
      <li>
        <a href="https://www.letswrite.tw/google-excel-db/" target="_blank">Google Sheets / Excel 當作資料庫</a>
      </li>
    </ul> -->
  </body>
</html>
